<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConcursoMaster AI - Plataforma Premium</title>
    
    <style>
        /* --- ESTILOS PREMIUM v4.1 --- */
        :root {
            --color-primary: #1e88e5;
            --color-primary-dark: #1565c0;
            --color-secondary: #546e7a;
            --color-success: #43a047;
            --color-warning: #ff9800;
            --color-danger: #e53935;
            --color-light: #f8f9fa;
            --color-white: #ffffff;
            --color-dark: #212529;
            --shadow-card: 0 6px 20px rgba(0, 0, 0, 0.12);
            --shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
            --gradient-primary: linear-gradient(135deg, #1e88e5 0%, #0d47a1 100%);
            --gradient-success: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            --gradient-danger: linear-gradient(135deg, #e53935 0%, #c62828 100%);
            --gradient-warning: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: var(--color-white);
            border-radius: 16px;
            box-shadow: var(--shadow-card);
            overflow: hidden;
            margin-top: 80px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .container:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        /* NAVEGAÇÃO SUPERIOR PREMIUM */
        nav {
            width: 100%;
            background: var(--gradient-primary);
            border-bottom: none;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        nav ul {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            list-style: none;
            display: flex;
            justify-content: flex-start;
        }

        nav a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 1.1em;
            padding: 18px 22px;
            display: block;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
        }

        nav a:hover {
            color: var(--color-white);
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        nav a.active {
            color: var(--color-white);
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.15);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 60%;
            height: 3px;
            background-color: #ffeb3b;
            border-radius: 2px;
        }

        /* HEADER COM GRADIENTE */
        .header {
            background: var(--gradient-primary);
            color: var(--color-white);
            padding: 25px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1%, transparent 1%);
            background-size: 20px 20px;
            opacity: 0.3;
        }

        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 600;
            position: relative;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-counter {
            font-size: 1.2em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #timer {
            color: #ffeb3b;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 10px;
            border-radius: 6px;
            min-width: 100px;
            text-align: center;
        }

        /* CRONÔMETRO DURANTE O SIMULADO */
        .cronometro-simulado {
            background: var(--gradient-warning);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: var(--shadow-card);
            display: none;
        }

        .cronometro-simulado h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }

        .tempo-restante {
            font-size: 2em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }

        .alerta-tempo {
            background: var(--color-danger) !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* PAINEL DE CONTROLE PREMIUM */
        #controle-sessao {
            padding: 40px;
            background: var(--color-white);
        }

        #controle-sessao h2 {
            color: var(--color-primary);
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        #controle-sessao > p {
            color: var(--color-secondary);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        /* SELEÇÃO AVANÇADA DE DISCIPLINAS */
        .disciplinas-avancadas {
            background: var(--color-light);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .disciplinas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .disciplina-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: var(--color-white);
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .disciplina-checkbox:hover {
            border-color: var(--color-primary);
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .disciplina-checkbox input[type="checkbox"] {
            margin: 0;
            transform: scale(1.2);
        }

        .disciplina-checkbox.checked {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .controles-avancados {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .controle-btn {
            padding: 10px 15px;
            background: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .controle-btn:hover {
            background: #455a64;
            transform: translateY(-1px);
        }

        .filter-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .filter-group input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: var(--color-white);
        }

        .filter-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }

        .mode-button {
            padding: 20px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .mode-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .mode-button:hover::before {
            left: 100%;
        }

        .mode-button:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .mode-button:active {
            transform: translateY(-2px);
        }

        #btn-iniciar-estudo {
            background: var(--gradient-success);
        }

        #btn-iniciar-simulado {
            background: var(--gradient-primary);
        }

        .button-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .button-description {
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 400;
        }

        /* ÁREA DA QUESTÃO PREMIUM */
        .question-box {
            padding: 40px;
        }

        .question-header {
            font-size: 1em;
            color: var(--color-secondary);
            background: var(--color-light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            border-left: 4px solid var(--color-primary);
        }

        .question-header strong {
            font-weight: 600;
            color: var(--color-primary);
        }

        .question-enunciado {
            font-size: 1.3em;
            font-weight: 400;
            line-height: 1.8;
            margin-bottom: 35px;
            color: var(--color-dark);
            background: var(--color-white);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: var(--shadow-card);
        }

        /* DICA/FÓRMULA PREMIUM - MELHORADA */
        #dica-antes-de-responder {
            display: none;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 12px;
            line-height: 1.7;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #90caf9;
            color: #1565c0;
            position: relative;
            overflow: hidden;
        }

        #dica-antes-de-responder::before {
            content: '💡';
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 1.5em;
        }

        #dica-antes-de-responder strong {
            color: var(--color-primary);
            display: block;
            margin-bottom: 10px;
            margin-left: 40px;
            font-size: 1.1em;
        }

        #dica-antes-de-responder pre {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.95em;
            margin: 15px 0 0 40px;
            padding: 15px;
            background-color: var(--color-white);
            border-left: 4px solid var(--color-primary);
            border-radius: 0 8px 8px 0;
            white-space: pre-wrap;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .dica-contextual {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid var(--color-success);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
        }

        .dica-contextual strong {
            color: var(--color-success);
        }

        /* ALTERNATIVAS PREMIUM */
        .alternativas-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .alternativa {
            display: flex;
            width: 100%;
            padding: 20px 25px;
            font-size: 1.1em;
            text-align: left;
            background-color: var(--color-white);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            line-height: 1.5;
            position: relative;
            overflow: hidden;
        }

        .alternativa::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--color-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .alternativa:hover::before {
            opacity: 1;
        }

        .alternativa:hover:not(:disabled) {
            background-color: #f8f9fa;
            border-color: var(--color-primary);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .alternativa-letra {
            font-weight: bold;
            margin-right: 20px;
            color: var(--color-primary);
            min-width: 30px;
            font-size: 1.1em;
            background: #e3f2fd;
            padding: 5px 10px;
            border-radius: 6px;
            text-align: center;
        }

        .alternativa.correta {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: var(--color-success);
            color: #1b5e20;
        }

        .alternativa.incorreta {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: var(--color-danger);
            color: #b71c1c;
        }

        .alternativa:disabled {
            cursor: default;
            opacity: 1;
            box-shadow: none;
        }

        .alternativa:disabled:not(.correta):not(.incorreta) {
            background-color: #fafafa;
        }

        /* FEEDBACK PREMIUM */
        #feedback-area {
            margin-top: 35px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e9ecef;
            box-shadow: var(--shadow-card);
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feedback-header {
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-header.correta {
            background: var(--gradient-success);
            color: white;
        }

        .feedback-header.incorreta {
            background: var(--gradient-danger);
            color: white;
        }

        .feedback-body {
            padding: 25px;
            background-color: var(--color-white);
        }

        .feedback-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-left: 4px solid #cfd8dc;
            padding-left: 20px;
            line-height: 1.7;
        }

        .feedback-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .feedback-section strong {
            color: var(--color-secondary);
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        #feedback-text-sua {
            color: #444;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            display: block;
            margin-top: 5px;
        }

        #feedback-text-gabarito {
            color: var(--color-success);
            font-weight: 600;
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            display: block;
            margin-top: 5px;
        }

        .analise-tempo {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--color-warning);
        }

        /* BOTÕES DE NAVEGAÇÃO PREMIUM */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 35px;
        }

        .action-buttons button {
            padding: 18px 25px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .action-buttons button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .action-buttons button:hover::before {
            left: 100%;
        }

        .action-buttons button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        #prev-question-btn {
            background: var(--gradient-warning);
        }

        #prev-question-btn:hover:not(:disabled) {
            background: #f57c00;
        }

        #next-question-btn {
            background: var(--gradient-primary);
        }

        #next-question-btn:hover:not(:disabled) {
            background: var(--color-primary-dark);
        }

        #next-question-btn:disabled, #prev-question-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* BOTÃO FINALIZAR PREMIUM */
        #btn-finalizar-sessao {
            background: var(--gradient-danger);
            color: white;
            margin-top: 30px;
            width: 100%;
            font-size: 1.1em !important;
            padding: 18px !important;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #btn-finalizar-sessao:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(229, 57, 53, 0.3);
        }

        /* RESULTADO FINAL PREMIUM */
        .resultado-final {
            text-align: center;
            padding: 50px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            margin: 20px 0;
        }

        .resultado-final h2 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .resultado-final .mode-tag {
            font-size: 1.2em;
            margin-bottom: 20px;
            display: block;
            font-weight: 500;
            opacity: 0.9;
        }

        .resultado-final strong.score {
            font-size: 5em;
            display: block;
            margin: 30px 0;
            font-weight: 800;
            text-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .metricas-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metrica {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .metrica .valor {
            font-size: 2em;
            font-weight: 700;
            display: block;
        }

        .metrica .label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .analise-final {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        /* LOADING ANIMATION */
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* SISTEMA DE NOTIFICAÇÕES */
        .notificacao {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid var(--color-primary);
            max-width: 350px;
        }

        .notificacao.sucesso {
            border-left-color: var(--color-success);
        }

        .notificacao.alerta {
            border-left-color: var(--color-warning);
        }

        .notificacao.erro {
            border-left-color: var(--color-danger);
        }

        .notificacao-icone {
            font-size: 1.3em;
        }

        .notificacao button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .mode-buttons, .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .question-header {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin-top: 120px;
            }
            
            .disciplinas-grid {
                grid-template-columns: 1fr;
            }
            
            .notificacao {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* MODO ACESSIBILIDADE */
        .modo-alto-contraste {
            filter: contrast(1.5);
            background: #000 !important;
            color: #fff !important;
        }

        .modo-daltonismo {
            filter: grayscale(1);
        }

        .tamanho-fonte-grande {
            font-size: 1.2em !important;
        }

        .tamanho-fonte-muito-grande {
            font-size: 1.5em !important;
        }

        /* NOVO: INDICADOR DE PROGRESSO */
        .progresso-sessao {
            background: var(--color-light);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .barra-progresso {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progresso-preenchido {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
    </style>
</head>
<body onload="inicializarSistema()">

    <nav>
        <ul>
            <li><a href="index.html" class="active">🎯 Questões</a></li>
            <li><a href="redacao.html">✍️ Redação</a></li>
            <li><a href="dashboard.html">📈 Dashboard</a></li>
        </ul>
    </nav>

    <div class="container">
        <header class="header">
            <h1>🚀 ConcursoMaster AI Premium</h1>
            <span id="q-counter" class="header-counter">
                📊 Selecione o Modo
                <span id="timer"></span>
            </span>
        </header>

        <main class="question-box">
            
            <div id="controle-sessao">
                <h2>🎯 Iniciar Sessão de Estudos</h2>
                <p>Escolha entre modo estudo com feedback imediato ou simulado completo como uma prova real</p>
                
                <!-- NOVO: Indicador de Progresso -->
                <div class="progresso-sessao" id="progresso-sessao">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>Progresso da Sessão</span>
                        <span id="progresso-texto">0%</span>
                    </div>
                    <div class="barra-progresso">
                        <div class="progresso-preenchido" id="progresso-barra" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="disciplinas-avancadas">
                    <h3>📚 Seleção de Conteúdo</h3>
                    <p>Selecione as disciplinas que deseja estudar</p>
                    
                    <div class="disciplinas-grid" id="disciplinas-grid">
                        <!-- Carregado dinamicamente -->
                    </div>
                    
                    <div class="controles-avancados">
                        <button class="controle-btn" onclick="selecionarTodasDisciplinas()">
                            ✅ Selecionar Todas
                        </button>
                        <button class="controle-btn" onclick="desselecionarTodasDisciplinas()">
                            ❌ Limpar Seleção
                        </button>
                        <button class="controle-btn" onclick="selecionarDisciplinasPrioritarias()">
                            🎯 Disciplinas Prioritárias
                        </button>
                    </div>
                </div>

                <div class="filter-group">
                    <input type="number" id="qtd-questoes" placeholder="🎯 Quantidade de Questões (20-295)" min="1" max="295" value="20">
                </div>

                <div class="mode-buttons">
                    <button id="btn-iniciar-estudo" onclick="iniciarSessao('estudo')">
                        <span class="button-icon">📚</span>
                        Modo Estudo
                        <span class="button-description">Feedback imediato e aprendizado ativo</span>
                    </button>
                    <button id="btn-iniciar-simulado" onclick="iniciarSessao('simulado')">
                        <span class="button-icon">🎯</span>
                        Modo Simulado
                        <span class="button-description">Prova real com cronômetro</span>
                    </button>
                </div>
            </div>
            
            <div id="questao-area" style="display: none;">
                <div class="cronometro-simulado" id="cronometro-simulado">
                    <h3>⏱️ Tempo do Simulado</h3>
                    <div class="tempo-restante" id="tempo-restante">--:--:--</div>
                    <div>Questão <span id="questao-atual-numero">1</span> de <span id="total-questoes-simulado">0</span></div>
                </div>
                
                <div id="loading-indicator" style="padding: 60px; text-align: center; color: var(--color-secondary); font-size: 1.2em;">
                    <div class="loading-spinner" style="border-top-color: var(--color-primary); margin: 0 auto 20px auto;"></div>
                    🚀 Carregando questão premium...
                </div>
                
                <div id="question-content-container"></div>
                
                <button id="btn-finalizar-sessao" onclick="finalizarSessaoAntecipada()" style="display: none;">
                    ❌ Finalizar Sessão Agora
                </button>
            </div>
            
        </main>
    </div>

    <script>
        const urlBase = 'http://127.0.0.1:8000';
        
        // Variáveis globais do sistema
        let modoSessao = null;
        let simuladoIds = [];
        let questaoAtualIndice = 0;
        let questaoCompletaAtual = null;
        
        // Sistema de tempo
        let startTime = null;
        let timerInterval = null;
        let totalTimeElapsed = 0;
        let cronometroSimuladoInterval = null;
        
        // Estatísticas da sessão
        let acertosSessao = 0;
        let pontuacaoSessao = 0.0;
        let totalQuestoesSessao = 0;
        let respostasDadas = 0;
        let notaMaximaSessao = 0.0;
        let respostasCache = {};
        let tempoPorQuestao = [];

        // Sistema de progresso
        let progresso = {
            disciplinas: {},
            tempoTotal: 0,
            questaoAtual: 0,
            data: new Date().toISOString().split('T')[0]
        };

        // Disciplinas disponíveis
        let disciplinasDisponiveis = [];

        // Estrutura HTML Premium da Questão
        const QUESTION_STRUCTURE_HTML = `
            <div class="question-header">
                <div><strong>📚 Disciplina:</strong> <span id="q-disciplina" class="loading-text">Carregando...</span></div>
                <div><strong>🎯 Assunto:</strong> <span id="q-assunto" class="loading-text">Carregando...</span></div>
                <div><strong>⚖️ Peso:</strong> <span id="q-peso" class="loading-text">Carregando...</span></div>
            </div>
            <div id="q-enunciado-wrapper">
                <p class="question-enunciado" id="q-enunciado">
                    <div class="loading-spinner" style="border-top-color: var(--color-primary); display: inline-block; margin-right: 10px;"></div>
                    Carregando enunciado premium...
                </p>
            </div>
            <div id="dica-antes-de-responder">
                <strong>💡 Dicas Específicas</strong>
                <span id="dica-antes-texto"></span>
            </div>
            <div class="alternativas-grid" id="alternativas-grid"></div>
            <div id="feedback-area" style="display: none;">
                <div id="feedback-header" class="feedback-header">
                    <span id="feedback-icon"></span>
                    <span id="feedback-title"></span>
                </div>
                <div class="feedback-body">
                    <div id="feedback-just-sua" class="feedback-section">
                        <strong>📝 Sua Resposta:</strong>
                        <span id="feedback-text-sua" class="justificativa-texto"></span>
                    </div>
                    <div id="feedback-just-gabarito" class="feedback-section">
                        <strong>✅ Resposta Correta:</strong>
                        <span id="feedback-text-gabarito" class="justificativa-gabarito"></span>
                    </div>
                    <div id="feedback-analise" class="analise-tempo" style="display: none;">
                        <strong>📊 Análise do Desempenho:</strong>
                        <span id="feedback-analise-texto"></span>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button id="prev-question-btn" onclick="voltarQuestao()" disabled>
                    ⬅️ Questão Anterior
                </button>
                <button id="next-question-btn" onclick="proximaQuestao()">
                    Próxima Questão ➡️
                </button>
            </div>
        `;

        // --- SISTEMA DE NOTIFICAÇÕES ---
        class NotificacaoSistema {
            static mostrar(mensagem, tipo = 'info', tempo = 5000) {
                const notification = document.createElement('div');
                notification.className = `notificacao ${tipo}`;
                notification.innerHTML = `
                    <span class="notificacao-icone">${this.getIcone(tipo)}</span>
                    <span class="notificacao-texto">${mensagem}</span>
                    <button onclick="this.parentElement.remove()">×</button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, tempo);
            }
            
            static getIcone(tipo) {
                const icones = {
                    'info': 'ℹ️',
                    'sucesso': '✅',
                    'alerta': '⚠️',
                    'erro': '❌'
                };
                return icones[tipo] || 'ℹ️';
            }
        }

        // --- SISTEMA DE PROGRESSO ---
        function atualizarProgresso(disciplina, acertou, tempo) {
            if (!progresso.disciplinas[disciplina]) {
                progresso.disciplinas[disciplina] = { acertos: 0, erros: 0, tempoTotal: 0 };
            }
            
            if (acertou) {
                progresso.disciplinas[disciplina].acertos++;
            } else {
                progresso.disciplinas[disciplina].erros++;
            }
            
            progresso.disciplinas[disciplina].tempoTotal += tempo;
            progresso.tempoTotal += tempo;
            progresso.questaoAtual++;
            
            salvarProgressoLocal();
            verificarMetas();
        }

        function salvarProgressoLocal() {
            const progressoSalvo = JSON.parse(localStorage.getItem('progresso_diario') || '{}');
            const hoje = new Date().toDateString();
            
            if (!progressoSalvo[hoje]) {
                progressoSalvo[hoje] = [];
            }
            
            progressoSalvo[hoje].push({
                timestamp: new Date().toISOString(),
                progresso: { ...progresso }
            });
            
            localStorage.setItem('progresso_diario', JSON.stringify(progressoSalvo));
        }

        function verificarMetas() {
            const metas = {
                diaria: { questao: 20, tempo: 3600, acertos: 15 }
            };
            
            const hoje = new Date().toDateString();
            const progressoHoje = JSON.parse(localStorage.getItem('progresso_diario') || '{}')[hoje];
            
            if (!progressoHoje) return;
            
            const totalQuestoesHoje = progressoHoje.reduce((total, entry) => {
                return total + (entry.progresso.questaoAtual || 0);
            }, 0);
            
            const totalAcertosHoje = progressoHoje.reduce((total, entry) => {
                return total + Object.values(entry.progresso.disciplinas || {}).reduce((sum, disc) => sum + (disc.acertos || 0), 0);
            }, 0);
            
            if (totalQuestoesHoje >= metas.diaria.questao) {
                NotificacaoSistema.mostrar('🎯 Meta diária de questões atingida!', 'sucesso');
            }
            
            if (totalAcertosHoje >= metas.diaria.acertos) {
                NotificacaoSistema.mostrar('⭐ Excelente rendimento hoje!', 'sucesso');
            }
        }

        // --- INICIALIZAÇÃO DO SISTEMA ---
        async function inicializarSistema() {
            await carregarDisciplinas();
            await carregarDisciplinasAvancadas();
            NotificacaoSistema.mostrar('Sistema carregado com sucesso!', 'sucesso', 3000);
        }

        // --- SISTEMA DE TEMPO PREMIUM ---
        function startTimer() {
            startTime = Date.now();
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('timer').style.display = 'inline';
            
            timerInterval = setInterval(() => {
                totalTimeElapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').innerText = formatTime(totalTimeElapsed);
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer').style.display = 'none';
        }

        function startCronometroSimulado() {
            const cronometroElement = document.getElementById('cronometro-simulado');
            const tempoRestanteElement = document.getElementById('tempo-restante');
            
            cronometroElement.style.display = 'block';
            let tempoDecorrido = 0;
            
            if (cronometroSimuladoInterval) clearInterval(cronometroSimuladoInterval);
            
            cronometroSimuladoInterval = setInterval(() => {
                tempoDecorrido++;
                tempoRestanteElement.textContent = formatTime(tempoDecorrido);
                
                // Alerta visual quando passar de 1 hora
                if (tempoDecorrido > 3600) {
                    cronometroElement.classList.add('alerta-tempo');
                }
            }, 1000);
        }

        function stopCronometroSimulado() {
            if (cronometroSimuladoInterval) {
                clearInterval(cronometroSimuladoInterval);
            }
            document.getElementById('cronometro-simulado').style.display = 'none';
        }
        
        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        // --- SISTEMA AVANÇADO DE SELEÇÃO DE DISCIPLINAS ---
        async function carregarDisciplinas() {
            try {
                const response = await fetch(`${urlBase}/disciplinas`);
                if (!response.ok) throw new Error('Erro ao carregar disciplinas');
                
                const data = await response.json();
                disciplinasDisponiveis = data.disciplinas || [];
                
                const responseTotal = await fetch(`${urlBase}/questoes/total`);
                if (responseTotal.ok) {
                    const dataTotal = await responseTotal.json();
                    const totalGeral = dataTotal.total_questoes;
                    
                    document.getElementById('qtd-questoes').max = totalGeral;
                    document.getElementById('qtd-questoes').placeholder = `🎯 Quantidade (20-${totalGeral})`;
                }

            } catch (error) {
                console.error("❌ Erro ao carregar disciplinas:", error);
                NotificacaoSistema.mostrar("Erro de conexão com o servidor", "erro");
                // Valores padrão como fallback
                disciplinasDisponiveis = ["Língua Portuguesa", "Matemática", "Direito Administrativo", "Direito Constitucional"];
            }
        }

        async function carregarDisciplinasAvancadas() {
            try {
                const grid = document.getElementById('disciplinas-grid');
                grid.innerHTML = '';
                
                if (disciplinasDisponiveis.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--color-secondary);">⚠️ Nenhuma disciplina disponível</div>';
                    return;
                }
                
                disciplinasDisponiveis.forEach(disciplina => {
                    const checkbox = document.createElement('label');
                    checkbox.className = 'disciplina-checkbox';
                    checkbox.innerHTML = `
                        <input type="checkbox" name="disciplina" value="${disciplina}">
                        <span>${disciplina}</span>
                    `;
                    grid.appendChild(checkbox);
                });
                
                // Adicionar event listeners
                document.querySelectorAll('.disciplina-checkbox input').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        this.parentElement.classList.toggle('checked', this.checked);
                    });
                });
                
                // Selecionar algumas por padrão
                selecionarDisciplinasPrioritarias();
                
            } catch (error) {
                console.error("❌ Erro ao carregar disciplinas avançadas:", error);
            }
        }

        function selecionarTodasDisciplinas() {
            document.querySelectorAll('.disciplina-checkbox input').forEach(checkbox => {
                checkbox.checked = true;
                checkbox.parentElement.classList.add('checked');
            });
        }

        function desselecionarTodasDisciplinas() {
            document.querySelectorAll('.disciplina-checkbox input').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('checked');
            });
        }

        function selecionarDisciplinasPrioritarias() {
            const prioritarias = ['Língua Portuguesa', 'Matemática', 'Direito Administrativo', 'Direito Constitucional'];
            
            document.querySelectorAll('.disciplina-checkbox input').forEach(checkbox => {
                const isPrioritaria = prioritarias.includes(checkbox.value);
                checkbox.checked = isPrioritaria;
                checkbox.parentElement.classList.toggle('checked', isPrioritaria);
            });
        }

        function obterDisciplinasSelecionadas() {
            const checkboxes = document.querySelectorAll('.disciplina-checkbox input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // --- ATUALIZAR PROGRESSO DA SESSÃO ---
        function atualizarProgressoSessao() {
            const progressoElement = document.getElementById('progresso-sessao');
            const progressoTexto = document.getElementById('progresso-texto');
            const progressoBarra = document.getElementById('progresso-barra');
            
            if (totalQuestoesSessao > 0) {
                const percentual = Math.round((questaoAtualIndice / totalQuestoesSessao) * 100);
                progressoTexto.textContent = `${percentual}%`;
                progressoBarra.style.width = `${percentual}%`;
                progressoElement.style.display = 'block';
            } else {
                progressoElement.style.display = 'none';
            }
        }

        // --- INICIALIZAÇÃO DE SESSÃO PREMIUM ---
        async function iniciarSessao(modo) {
            modoSessao = modo;
            
            // Obter disciplinas selecionadas
            const disciplinasSelecionadas = obterDisciplinasSelecionadas();
            if (disciplinasSelecionadas.length === 0) {
                NotificacaoSistema.mostrar("Selecione pelo menos uma disciplina", "alerta");
                return;
            }

            const qtdInput = document.getElementById('qtd-questoes').value;
            const quantidade = parseInt(qtdInput);

            if (quantidade <= 0 || isNaN(quantidade)) {
                NotificacaoSistema.mostrar("Insira uma quantidade válida", "alerta");
                return;
            }
            
            // Resetar variáveis de sessão
            questaoAtualIndice = 0;
            acertosSessao = 0;
            pontuacaoSessao = 0.0;
            respostasDadas = 0;
            respostasCache = {};
            notaMaximaSessao = 0.0;
            tempoPorQuestao = [];
            
            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('question-content-container').innerHTML = QUESTION_STRUCTURE_HTML;

            document.getElementById('controle-sessao').style.display = 'none';
            document.getElementById('questao-area').style.display = 'block';
            
            // Mostrar o botão de finalizar sessão
            document.getElementById('btn-finalizar-sessao').style.display = 'block';

            // Atualizar números do cronômetro
            document.getElementById('questao-atual-numero').textContent = '1';
            document.getElementById('total-questoes-simulado').textContent = quantidade;

            // Construir URL com disciplinas selecionadas
            let url = `${urlBase}/simulado/iniciar/${quantidade}?`;
            if (disciplinasSelecionadas.length > 0) {
                url += `disciplinas=${disciplinasSelecionadas.join(',')}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Erro ao criar simulado');
                }
                
                const data = await response.json();
                
                if (data.simulado_ids && data.simulado_ids.length > 0) {
                    simuladoIds = data.simulado_ids;
                    totalQuestoesSessao = data.total_simulado;

                    document.getElementById('loading-indicator').style.display = 'none';
                    
                    startTimer();
                    if (modo === 'simulado') {
                        startCronometroSimulado();
                    }
                    
                    // Calcular nota máxima
                    notaMaximaSessao = await calcularNotaMaximaTotal(simuladoIds);

                    carregarQuestao();
                    NotificacaoSistema.mostrar(`Sessão iniciada com ${totalQuestoesSessao} questões`, 'sucesso');

                } else {
                    throw new Error(data.detail || "Erro ao montar o teste");
                }

            } catch (error) {
                console.error("❌ Erro ao iniciar sessão:", error);
                NotificacaoSistema.mostrar(error.message || "Erro de conexão com o servidor", "erro");
                document.getElementById('loading-indicator').style.display = 'none';
                // Restaurar visibilidade do controle de sessão
                document.getElementById('controle-sessao').style.display = 'block';
                document.getElementById('questao-area').style.display = 'none';
            }
        }

        // --- CARREGAMENTO DE QUESTÃO PREMIUM ---
        async function carregarQuestao() {
            // Garantir que o botão de finalizar permaneça visível
            document.getElementById('btn-finalizar-sessao').style.display = 'block';
            
            resetarFeedback();
            document.getElementById('next-question-btn').disabled = true;

            // Verificar se é a última questão
            if (questaoAtualIndice >= totalQuestoesSessao) {
                await finalizarSessaoAntecipada();
                return;
            }

            const dbId = simuladoIds[questaoAtualIndice];
            document.getElementById('q-counter').innerText = 
                `${modoSessao === 'estudo' ? '📚' : '🎯'} ${modoSessao.toUpperCase()}: ${questaoAtualIndice + 1} / ${totalQuestoesSessao}`;
            
            // Atualizar número da questão no cronômetro
            document.getElementById('questao-atual-numero').textContent = questaoAtualIndice + 1;
            
            // Atualizar progresso
            atualizarProgressoSessao();
            
            try {
                const url = `${urlBase}/questao/${dbId}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Erro ao carregar questão');
                
                questaoCompletaAtual = await response.json();

                // Preenche os campos da página
                document.getElementById('q-disciplina').innerText = questaoCompletaAtual.disciplina;
                document.getElementById('q-assunto').innerText = questaoCompletaAtual.assunto;
                document.getElementById('q-enunciado').innerHTML = questaoCompletaAtual.enunciado;
                
                const peso = questaoCompletaAtual.peso_pontuacao.toFixed(1);
                document.getElementById('q-peso').innerText = `${peso} Ponto(s)`;

                // Cria os botões de alternativa
                const grid = document.getElementById('alternativas-grid');
                grid.innerHTML = '';
                const alternativas = ['A', 'B', 'C', 'D'].map(letra => ({
                    letra: letra,
                    texto: questaoCompletaAtual[`alt_${letra.toLowerCase()}`]
                }));

                alternativas.forEach(alt => {
                    grid.innerHTML += `
                        <button class="alternativa" id="btn-${alt.letra}" onclick="checkAnswer('${alt.letra}', this)">
                            <span class="alternativa-letra">${alt.letra}</span>
                            <span>${alt.texto}</span>
                        </button>
                    `;
                });

                mostrarDicasContextuais();
                atualizarBotoesNavegacao();
                
                if (respostasCache[dbId]) {
                    revisarQuestao(respostasCache[dbId]);
                } else if (modoSessao === 'simulado') {
                    // No modo simulado, o botão de próximo deve estar sempre habilitado
                    document.getElementById('next-question-btn').disabled = false;
                }

            } catch (error) {
                console.error("❌ Erro ao carregar questão:", error);
                document.getElementById('q-enunciado').innerText = `❌ Erro ao carregar questão: ${error.message}`;
            }
        }

        // --- SISTEMA DE DICAS CONTEXTUAIS MELHORADO ---
        function mostrarDicasContextuais() {
            const dicaContainer = document.getElementById('dica-antes-de-responder');
            const dicaTexto = document.getElementById('dica-antes-texto');
            
            if (!questaoCompletaAtual) return;
            
            let dicaHTML = '';
            const disciplina = questaoCompletaAtual.disciplina;
            
            // Dicas específicas por disciplina
            if (disciplina.includes('Matemática') || disciplina.includes('Raciocínio')) {
                dicaHTML += `
                    <div class="dica-contextual">
                        <strong>📐 Dica Matemática:</strong>
                        <p>• Leia cuidadosamente os dados numéricos</p>
                        <p>• Identifique a operação matemática necessária</p>
                        <p>• Verifique as unidades de medida</p>
                        <p>• Confira se o resultado faz sentido no contexto</p>
                    </div>
                `;
                
                if (questaoCompletaAtual.formula_aplicavel) {
                    dicaHTML += `
                        <div style="padding: 15px; border-radius: 8px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid var(--color-success); margin-top: 10px;">
                            <strong>📊 Fórmula Aplicável:</strong>
                            <pre style="background: white; padding: 10px; border-radius: 4px; margin-top: 8px; font-family: 'Consolas', monospace;">${questaoCompletaAtual.formula_aplicavel}</pre>
                        </div>
                    `;
                }
            }
            
            if (disciplina.includes('Português')) {
                dicaHTML += `
                    <div class="dica-contextual">
                        <strong>📖 Dica Português:</strong>
                        <p>• Identifique o tema central do texto</p>
                        <p>• Observe elementos de coesão e coerência</p>
                        <p>• Analise a função dos conectivos</p>
                        <p>• Verifique concordância e regência</p>
                    </div>
                `;
            }
            
            if (disciplina.includes('Direito')) {
                dicaHTML += `
                    <div class="dica-contextual">
                        <strong>⚖️ Dica Direito:</strong>
                        <p>• Identifique o instituto jurídico</p>
                        <p>• Lembre-se dos princípios aplicáveis</p>
                        <p>• Considere a hierarquia das normas</p>
                        <p>• Atenção aos prazos processuais</p>
                    </div>
                `;
            }
            
            if (questaoCompletaAtual.dica_interpretacao) {
                dicaHTML += `
                    <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; margin-top: 15px; border-left: 4px solid #607d8b;">
                        <strong>🎯 Dica Específica desta Questão:</strong>
                        <p>${questaoCompletaAtual.dica_interpretacao}</p>
                    </div>
                `;
            }
            
            if (dicaHTML) {
                dicaTexto.innerHTML = dicaHTML;
                dicaContainer.style.display = 'block';
            } else {
                dicaContainer.style.display = 'none';
            }
        }

        // --- VERIFICAÇÃO DE RESPOSTA PREMIUM ---
        async function checkAnswer(letra, botaoClicado, isRevisiting = false) {
            // Se já respondeu (cache existe), não faz nada
            if (respostasCache[questaoCompletaAtual.id]) return;
            
            // Trava todos os botões de alternativa
            document.querySelectorAll('.alternativa').forEach(btn => btn.disabled = true);

            const questaoInicioTempo = Date.now();
            const alternativaCorreta = questaoCompletaAtual.gabarito;
            const acertou = letra.toUpperCase() === alternativaCorreta.toUpperCase();
            
            // Calcular tempo de resposta
            const tempoResposta = Math.floor((Date.now() - questaoInicioTempo) / 1000);
            tempoPorQuestao.push(tempoResposta);

            // Atualizar progresso
            atualizarProgresso(questaoCompletaAtual.disciplina, acertou, tempoResposta);

            // Cache da resposta ANTES de registrar, para UI
            respostasCache[questaoCompletaAtual.id] = {
                alternativa: letra,
                acertou: acertou,
                tempo: tempoResposta
            };

            // Atualizar estatísticas de sessão
            if (acertou) {
                acertosSessao++;
                pontuacaoSessao += questaoCompletaAtual.peso_pontuacao;
            }
            respostasDadas++;

            // Estilizar botões (correto/incorreto)
            if (botaoClicado) {
                botaoClicado.classList.add(acertou ? 'correta' : 'incorreta');
            }
            if (!acertou) {
                const btnCorreto = document.getElementById(`btn-${alternativaCorreta}`);
                if (btnCorreto) {
                    btnCorreto.classList.add('correta');
                }
            }
            
            // --- Lógica de Feedback e Navegação ---
            if (modoSessao === 'estudo') {
                // Modo Estudo: Mostra feedback e espera
                try {
                    const response = await fetch(`${urlBase}/questao/responder`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            questao_id: questaoCompletaAtual.id,
                            alternativa_escolhida: letra,
                            tempo_resposta: tempoResposta
                        })
                    });
                    
                    if (!response.ok) throw new Error('Erro ao registrar resposta');
                    
                    const resultado = await response.json();
                    
                    if (acertou) {
                        NotificacaoSistema.mostrar('✅ Resposta correta!', 'sucesso', 2000);
                    } else {
                        NotificacaoSistema.mostrar('❌ Resposta incorreta.', 'alerta', 3000);
                    }
                    
                    mostrarFeedback(acertou, letra, alternativaCorreta, resultado);
                    document.getElementById('next-question-btn').disabled = false;

                } catch (error) {
                    console.error("❌ Erro ao registrar resposta:", error);
                    NotificacaoSistema.mostrar("Erro ao processar resposta", "erro");
                    document.getElementById('next-question-btn').disabled = false;
                }

            } else {
                // Modo Simulado: Não mostra feedback, apenas registra no background
                document.getElementById('next-question-btn').disabled = false;
                
                // Envia a resposta em background, sem esperar (fire-and-forget)
                fetch(`${urlBase}/questao/responder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        questao_id: questaoCompletaAtual.id,
                        alternativa_escolhida: letra,
                        tempo_resposta: tempoResposta
                    })
                }).catch(error => console.error("Erro ao registrar resposta em background:", error));
            }
        }

        // --- SISTEMA DE FEEDBACK PREMIUM ---
        function mostrarFeedback(acertou, respostaUsuario, respostaCorreta, resultadoAPI) {
            const feedbackArea = document.getElementById('feedback-area');
            const feedbackHeader = document.getElementById('feedback-header');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackSua = document.getElementById('feedback-text-sua');
            const feedbackGabarito = document.getElementById('feedback-text-gabarito');
            const feedbackAnalise = document.getElementById('feedback-analise');
            const feedbackAnaliseTexto = document.getElementById('feedback-analise-texto');

            // Configurar header do feedback
            if (acertou) {
                feedbackHeader.className = 'feedback-header correta';
                feedbackIcon.textContent = '✅';
                feedbackTitle.textContent = 'Resposta Correta!';
            } else {
                feedbackHeader.className = 'feedback-header incorreta';
                feedbackIcon.textContent = '❌';
                feedbackTitle.textContent = 'Resposta Incorreta';
            }

            // Preencher justificativas
            feedbackSua.textContent = resultadoAPI.justificativa_escolhida || 
                `Você escolheu a alternativa ${respostaUsuario}.`;
            
            feedbackGabarito.textContent = resultadoAPI.justificativa_correta || 
                `A alternativa correta é ${respostaCorreta}.`;

            // Análise de desempenho
            if (resultadoAPI.analise_desempenho) {
                feedbackAnaliseTexto.textContent = resultadoAPI.analise_desempenho;
                feedbackAnalise.style.display = 'block';
            }

            feedbackArea.style.display = 'block';

            // Scroll suave para o feedback
            feedbackArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // --- FUNÇÕES AUXILIARES ---
        function resetarFeedback() {
            document.getElementById('feedback-area').style.display = 'none';
            document.getElementById('feedback-analise').style.display = 'none';
        }

        function atualizarBotoesNavegacao() {
            document.getElementById('prev-question-btn').disabled = questaoAtualIndice === 0;
            document.getElementById('next-question-btn').disabled = false;
        }

        function voltarQuestao() {
            if (questaoAtualIndice > 0) {
                questaoAtualIndice--;
                carregarQuestao();
            }
        }
        
        // ==================================================
        // FUNÇÃO 'proximaQuestao' CORRIGIDA
        // ==================================================
        async function proximaQuestao() {
            // Verifica se é a última questão
            if (questaoAtualIndice >= totalQuestoesSessao - 1) {
                // Última questão - Iniciar processo de finalização
                
                // 1. Parar cronômetros
                stopTimer();
                stopCronometroSimulado();
                
                // 2. Mostrar indicador de salvamento
                document.getElementById('question-content-container').innerHTML = `
                    <div style="padding: 60px; text-align: center; color: var(--color-secondary); font-size: 1.2em;">
                        <div class="loading-spinner" style="border-top-color: var(--color-primary); margin: 0 auto 20px auto;"></div>
                        💾 Registrando seu resultado...
                    </div>
                `;
                // Esconder botão de finalizar (pois já estamos finalizando)
                document.getElementById('btn-finalizar-sessao').style.display = 'none';

                // 3. Registrar o histórico (se for simulado)
                if (modoSessao === 'simulado') {
                    await registrarHistoricoSimulado();
                }
                
                // 4. Mostrar a tela de resultados
                mostrarFim();

            } else {
                // Se não for a última, apenas avança
                questaoAtualIndice++;
                carregarQuestao();
            }
        }

        function revisarQuestao(respostaCache) {
            // No modo simulado, ao voltar, apenas mostramos qual foi marcada
            // No modo estudo, mostramos o feedback completo
            
            document.querySelectorAll('.alternativa').forEach(btn => btn.disabled = true);
            
            const botaoClicado = document.getElementById(`btn-${respostaCache.alternativa}`);
            const alternativaCorreta = questaoCompletaAtual.gabarito;
            
            if (botaoClicado) {
                botaoClicado.classList.add(respostaCache.acertou ? 'correta' : 'incorreta');
            }
            if (!respostaCache.acertou) {
                const btnCorreto = document.getElementById(`btn-${alternativaCorreta}`);
                if (btnCorreto) {
                    btnCorreto.classList.add('correta');
                }
            }

            if (modoSessao === 'estudo') {
                // Recarrega o feedback se estiver em modo estudo
                document.getElementById('feedback-area').style.display = 'block';
                const feedbackHeader = document.getElementById('feedback-header');
                const feedbackTitle = document.getElementById('feedback-title');
                const feedbackIcon = document.getElementById('feedback-icon');

                if (respostaCache.acertou) {
                    feedbackHeader.className = 'feedback-header correta';
                    feedbackIcon.textContent = '✅';
                    feedbackTitle.textContent = 'Resposta Correta (Revisão)';
                } else {
                    feedbackHeader.className = 'feedback-header incorreta';
                    feedbackIcon.textContent = '❌';
                    feedbackTitle.textContent = 'Resposta Incorreta (Revisão)';
                }
                // Oculta justificativas pois não as temos em cache
                document.getElementById('feedback-just-sua').style.display = 'none';
                document.getElementById('feedback-just-gabarito').style.display = 'none';
            }
        }

        async function calcularNotaMaximaTotal(ids) {
            let maxScore = 0.0;
            for (const id of ids) {
                try {
                    const response = await fetch(`${urlBase}/questao/${id}`);
                    if (response.ok) {
                        const q = await response.json();
                        maxScore += q.peso_pontuacao || 1.0;
                    }
                } catch (e) {
                    console.error(`❌ Erro ao obter peso da questão ${id}:`, e);
                }
            }
            return maxScore;
        }

        // ==================================================
        // FUNÇÃO 'finalizarSessaoAntecipada' CORRIGIDA
        // ==================================================
        async function finalizarSessaoAntecipada() {
            if (confirm("🎯 Tem certeza que deseja finalizar a sessão agora? Sua nota será calculada com base nas questões respondidas.")) {
                
                // 1. Parar cronômetros
                stopTimer();
                stopCronometroSimulado();
                
                // 2. Mostrar indicador de salvamento
                document.getElementById('question-content-container').innerHTML = `
                    <div style="padding: 60px; text-align: center; color: var(--color-secondary); font-size: 1.2em;">
                        <div class="loading-spinner" style="border-top-color: var(--color-primary); margin: 0 auto 20px auto;"></div>
                        💾 Registrando seu resultado...
                    </div>
                `;
                // Esconder botão de finalizar
                document.getElementById('btn-finalizar-sessao').style.display = 'none';

                // 3. Registrar histórico (se for simulado)
                if (modoSessao === 'simulado') {
                    await registrarHistoricoSimulado();
                }
                
                // 4. Mostrar tela de resultados
                mostrarFim();
            }
        }

        async function registrarHistoricoSimulado() {
            try {
                const response = await fetch(`${urlBase}/simulado/historico`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        total_questoes: totalQuestoesSessao,
                        acertos: acertosSessao,
                        pontuacao_final: pontuacaoSessao,
                        duracao_segundos: totalTimeElapsed
                    })
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    console.log("✅ Histórico registrado:", resultado);
                } else {
                    throw new Error('Erro ao registrar histórico');
                }
            } catch (error) {
                console.error("❌ Erro ao registrar histórico:", error);
                NotificacaoSistema.mostrar("Erro ao salvar histórico, mas resultados locais estão corretos.", "alerta");
            }
        }

        // ==================================================
        // FUNÇÃO 'mostrarFim' CORRIGIDA
        // ==================================================
        function mostrarFim() {
            // Os cronômetros JÁ FORAM PARADOS antes de chamar esta função
            
            const percentualAcertos = totalQuestoesSessao > 0 ? (acertosSessao / totalQuestoesSessao) * 100 : 0;
            const percentualPontuacao = notaMaximaSessao > 0 ? (pontuacaoSessao / notaMaximaSessao) * 100 : 0;
            const tempoMedio = tempoPorQuestao.length > 0 ? 
                tempoPorQuestao.reduce((a, b) => a + b) / tempoPorQuestao.length : 0;

            const resultadoHTML = `
                <div class="resultado-final">
                    <h2>🎉 ${modoSessao === 'estudo' ? 'Sessão de Estudo' : 'Simulado'} Concluído!</h2>
                    <span class="mode-tag">${modoSessao === 'estudo' ? '📚 Modo Estudo' : '🎯 Modo Simulado'}</span>
                    
                    <strong class="score">${percentualPontuacao.toFixed(1)}%</strong>
                    
                    <div class="metricas-container">
                        <div class="metrica">
                            <span class="valor">${acertosSessao}/${totalQuestoesSessao}</span>
                            <span class="label">✅ Questões Corretas</span>
                        </div>
                        <div class="metrica">
                            <span class="valor">${formatTime(totalTimeElapsed)}</span>
                            <span class="label">⏱️ Tempo Total</span>
                        </div>
                        <div class="metrica">
                            <span class="valor">${tempoMedio.toFixed(1)}s</span>
                            <span class="label">📊 Tempo Médio/Q</span>
                        </div>
                        <div class="metrica">
                            <span class="valor">${pontuacaoSessao.toFixed(1)}</span>
                            <span class="label">⚖️ Pontuação Total</span>
                        </div>
                    </div>
                    
                    <div class="analise-final">
                        <h3>📈 Análise do Desempenho</h3>
                        <p>${gerarAnaliseDesempenho(percentualPontuacao, tempoMedio)}</p>
                        <p><strong>🎯 Recomendação:</strong> ${gerarRecomendacao(percentualPontuacao)}</p>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button onclick="window.location.reload()" style="
                            background: var(--gradient-primary);
                            color: white;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 10px;
                            font-size: 1.1em;
                            cursor: pointer;
                            margin: 0 10px;
                        ">🔄 Nova Sessão</button>
                        
                        <button onclick="window.location.href='dashboard.html'" style="
                            background: var(--gradient-success);
                            color: white;
                            padding: 15px 30px;
                            border: none;
                            border-radius: 10px;
                            font-size: 1.1em;
                            cursor: pointer;
                            margin: 0 10px;
                        ">📊 Ver Dashboard</button>
                    </div>
                </div>
            `;
            
            document.getElementById('question-content-container').innerHTML = resultadoHTML;
            
            // Garante que o botão de finalizar sessão seja ocultado
            document.getElementById('btn-finalizar-sessao').style.display = 'none';
        }

        function gerarAnaliseDesempenho(percentual, tempoMedio) {
            if (percentual >= 90) return "🎖️ Desempenho Excepcional! Domínio completo do conteúdo.";
            if (percentual >= 70) return "✅ Bom desempenho! Continue evoluindo.";
            if (percentual >= 50) return "📚 Desempenho regular. Foque nas disciplinas com maior dificuldade.";
            return "🎯 Há espaço para melhoria. Revise os conceitos básicos e pratique mais.";
        }

        function gerarRecomendacao(percentual) {
            if (percentual >= 80) return "Mantenha o excelente ritmo de estudos!";
            if (percentual >= 60) return "Pratique mais questões das disciplinas com menor aproveitamento.";
            return "Estude os conteúdos fundamentais e refaça as questões erradas.";
        }

        // --- SISTEMA DE EXPORTAÇÃO ---
        function exportarDados() {
            const progresso = JSON.parse(localStorage.getItem('progresso_diario') || '{}');
            const dados = {
                progresso: progresso,
                historico: JSON.parse(localStorage.getItem('progresso_diario') || '{}'),
                dataExportacao: new Date().toISOString(),
                tipo: 'ConcursoMaster AI - Dados de Estudo'
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `concurcomaster_dados_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            NotificacaoSistema.mostrar('Dados exportados com sucesso!', 'sucesso');
        }

        // --- SISTEMA DE RECUPERAÇÃO DE FALHAS ---
        window.addEventListener('beforeunload', function (e) {
            if (modoSessao && questaoAtualIndice > 0) {
                // Salvar estado atual da sessão
                const estadoSessao = {
                    modo: modoSessao,
                    questaoAtual: questaoAtualIndice,
                    simuladoIds: simuladoIds,
                    respostasCache: respostasCache,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('sessao_autosave', JSON.stringify(estadoSessao));
            }
        });

        // Tentar recuperar sessão ao carregar
        function tentarRecuperarSessao() {
            const sessaoSalva = localStorage.getItem('sessao_autosave');
            if (sessaoSalva) {
                const estado = JSON.parse(sessaoSalva);
                if (confirm('📝 Encontramos uma sessão em andamento. Deseja continuar?')) {
                    // Implementar continuação da sessão
                    console.log('Continuando sessão:', estado);
                }
                // Limpar autosave independente da escolha
                localStorage.removeItem('sessao_autosave');
            }
        }

        // Inicializar recuperação de sessão
        document.addEventListener('DOMContentLoaded', tentarRecuperarSessao);
    </script>
</body>
</html>